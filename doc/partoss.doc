                      The Parma Tosser
                     FTN Echo Processor
                        version 1.06

1. Основные понятия. Терминология.

   Вначале - небольшой экскурс в историю. В середине 80-х годов группой
энтузиастов в США была создана любительская компьютерная сеть, названная
ими FIDONET. Принципы работы этой сети, стандарты ее функционирования,
программы для работы в составе этой сети с тех пор пишутся любителями
и для любителей. Но в последние годы появлилось большое количество других
сетей, построенных по той же технологии - FTN (FIDONET Technology Network),
в том числе и коммерческих.

   В основе сети FIDONET лежит понятие узла (Node). Узел - это самостоятельная
станция, обменивающаяся информацией с несколькими другими узлами. Группа
узлов, территориально близких друг к другу, образует сеть (Net). Группа сетей
по некоторому принципу объединяется в зону (Zone). В рамках FIDONET это
территориальный принцип - в настоящее время существует 6 зон, охватывающих
целые континенты. В других сетях, построенных по этой же технологии,
объединение в зоны может производиться по другому принципу.
   Каждый узел имеет свой, уникальный в пределах FIDONET (или другой сети),
сетевой адрес. Адрес этот имеет следующую структуру:

Zone:Net/Node.Point

Zone  - номер зоны.
Net   - номер сети.
Node  - номер узла.
Point - номер подчиненной станции (пойнт). Станция-пойнт имеет некоторые
        ограничения в свободе обмена информацией с другими станциями.

Строго говоря, в структуре адреса существует пятый элемент, называемый доменом
(Domain). Это самый верхний уровень иерархии, например, все зоны FIDONET имеют
домен fidonet. Этот элемент пока обрабатывается не всеми программами. Parma
Tosser пока не поддерживает domain-адресацию, просто игнорируя этот элемент,
если он присутствует в адресе.

   Основные функции узла FTN сети заключаются в обмене почтой и файлами с
другими узлами. Почта в FTN сети бывает двух видов: частная переписка, иначе
называемая нетмейл (NetMail), и письма в электронные конференции (которые в
FIDONET называются эхо-конференциями) - эхо-почта (EchoMail). Каждый узел FTN
сети для выполнения своих функций должен быть оснащен как соответствующими
аппаратными средствами (компьютер, модем, телефонная линия), так и
необходимыми программными средствами:

- мейлер (Mailer) - программа, осуществляющая собственно пересылку файлов и
почты по телефонной линии;

- эхопроцессор - программа поддержки эхо-почты, обеспечивающая хранение почты
в базе определенного формата, помещение в базу писем, пришедших с других
узлов, и подготовку к отправке поступившей и вновь созданной почты на другие
узлы, а также сопровождение почтовой базы, включая удаление старых писем,
связывание писем в цепочки "вопрос-ответ" и другие сервисные функции;

- редактор - программа, с помощью которой осуществляется доступ к почтовой
базе - чтение поступившей почты, написание собственных писем, в том числе в
ответ на пришедшие письма.

   Программа Parma Tosser - это эхопроцессор. Поэтому дальнейшее рассмотрение
вопросов технологии FTN сетей и используемой терминологии будет относиться
именно к этой части программного обеспечения узла сети.

Письмо - это блок информации, имеющий отправителя, получателя, текст письма
и некоторую управляющую информацию.
Эхо-конференция, или эхо-область - это объединяющая группу узлов сети
виртуальная структура, внутри которой циркулируют письма, объединенные
некоторой общей темой. Основное отличие эхомейла от нетмейла состоит в том,
что письмо, помещенное в эхо-область, будет (теоретически) прочитано каждым
из узлов, подключенным к этой эхо-области.
Эхотэг (EchoTag), или название области - уникальное имя, присвоенное эхо-
области при ее создании.

   Каждое письмо, созданное на узле каким-либо из редакторов, имеет строго
определенный формат. Этот формат определяется типом письма (нетмейл или
эхомейл), форматом почтовой базы и самим используемым редактором.
   Существуют следующие основные форматы хранения писем в базе:
- FIDO/OPUS формат;
- Squish;
- Hudson;
- JAM;
а также некоторые другие. Эхопроцессор Parma Tosser поддерживает форматы
FIDO/OPUS для нетмейла и Squish для эхо-почты.
В формате FIDO/OPUS каждое письмо содержится в отдельном файле, имеющем имя,
состоящее из десятичного числа, и расширение MSG: 1.Msg. Структура такого
файла описана в технических стандартах FIDONET.
В Squish-формате, впервые предложенном Dudley Scott и реализованном им в
своем эхопроцессоре Squish, письма хранятся в виде записей в файле сложной
структуры, причем каждая эхо-область хранится в отдельном файле. Кроме
основного файла, существуют вспомогательные - файл индексов и файл, содержащий
информацию о прошедших через узел письмах (это необходимо для отслеживания
ситуации повторного попадания в базу одного и того же письма). Редакторы
создают еще один вспомогательный файл, содержащий указатели на последнее
прочитанное письмо.

   Поскольку на разных узлах почтовая база может иметь различные форматы,
для обмена между узлами все отправляемые письма преобразуются в почтовый
пакет, структура которого описана в технических стандартах FIDONET. Кроме
этого, по причине больших объемов передаваемой почты и необходимости
сократить время пересылки (а следовательно, стоимость обмена), значительная
часть почты перед ее отправкой архивируется с использованием какого-либо
из архиваторов. Созданные архивы носят название аркмейл (ArcMail) и имеют
определенную структуру имени файла.
   Для того, чтобы мейлер смог отправить почту, необходимо специальное
указание. Вид этого указания зависит от используемого мейлера. Существуют
три основных типа мейлеров и, соответственно, три различных способа приказать
мейлеру отправить почту по назначению:
- ArcMailAttach;
- Bink Outbound;
- FileBoxes.
   ArcMailAttach - это самый "родной" для FIDONET тип мейлера. Для того,
чтобы некий файл был отправлен с узла A на узел B, создается специальное
письмо, содержащее указание - "отправь файл XXX.XXX на узел B". Это письмо
непосредственно обрабатывается мейлером и называется аттачем (Attach).
   Bink Outbound - это метод, при котором мейлер вообще не знает ничего о
почте (строго говоря, в этом случае он не является мейлером - это программа
для пересылки файлов). В этом случае в определенных каталогах должны лежать
файлы с определенными именами, содержащие списки файлов, которые необходимо
отослать другим узлам. При этом адрес узла-получателя определяется путем
анализа имени файла-указания и каталога, в котором он находится.
   FileBoxes - метод, предложенный Андреем Елкиным и реализованный в его
мейлере T-Mail. В этом методе для отправки файла какому-либо узлу этот файл
помещается в каталог с именем, которое однозначно определяет адрес узла-
получателя.

   Кроме адреса получателя, в любом из этих методов должен быть указан еще
и способ отправки. Узел, подготовивший почту для другого узла, может либо
сам звонить и пытаться отправить почту, либо ждать, когда получатель позвонит
и заберет предназначенную ему почту. Второй метод носит название "Hold" и
реализуется по-разному в разных типах мейлеров.

   Еще одно понятие, которое необходимо рассмотреть - атрибуты письма. Это
относится в основном к нетмейлу.
   Каждое письмо в составе управляющей информации содержит набор атрибутов,
или флагов, определяющих тип письма, срочность доставки, необходимость
автоматического ответа на него etc. Для эхопроцессора важны только некоторые
из этих атрибутов:
- DIR - письмо должно быть переслано непосредственно получателю (при отсутст-
вии такого атрибута вступают в силу правила раутинга (Routing), которые
обычно сокращают расходы на пересылку письма);
- CRA - срочное письмо. Действие аналогично атрибуту DIR;
- HLD - получатель сам должен позвонить и забрать это письмо;
- FRQ - запрос на получение определенного файла;
- ATT - аттач, указание отправить определенный файл.

2. Назначение и особенности программы Parma Tosser.

   Программа Parma Tosser (далее - ParToss) предназначена для управления
эхо-конференциями в FTN-сетях. Основные функции, выполняемые программой -
импорт эхо-почты из пришедших почтовых архивов в локальную базу и экспорт
новых писем в почтовые архивы для отправки подписчикам. ParToss написан для
замены известного эхопроцессора Squish. Поддерживаемые форматы - *.Msg для
нетмейла и Squish-формат для эхомейла.
   Программа содержит встроенные функции для сопровождения базы, внутренний
эхо-менеджер для управления подпиской, функцию автоматической генерации и
отправки писем по расписанию, функцию управления персональной почтой, а также
ряд вспомогательных функций. Основные методы работы и особенности поведения в
различных ситуациях настраиваются с помощью набора текстовых файлов
конфигурации.

3. Установка и конфигурация.

   Требования к компьютеру и программному обеспечению для работы ParToss
следующие:
- IBM PC совместимый компьютер;
- OS MS-DOS или ее клоны версии 3.30 и выше или
  OS/2 версии 2.0 и выше или
  Windows'95 или Windows NT;
- 512 K байт оперативной памяти (для версии под DOS);
- установка параметра FILES= в Config.Sys не меньше 30, для повышения
  производительности рекомендуется 50 и выше;
- около 1 Mb дискового пространства.
   Перед началом работы ParToss  должен быть настроен для соответствия
конфигурации Вашей почтовой станции.
   Установка и конфигурация состоит из трех шагов:
- разверните архив с программой и файлами конфигурации в какой-нибудь каталог
на Вашем диске;
- отредактируйте файлы конфигурации ParToss.Cfg, Compress.Cfg и Route.Cfg, а
также другие текстовые файлы (шаблоны и прочие), внимательно читая коммен-
тарии в этих файлах;
- исправьте .BAT или .CMD-файлы, управляющие работой Вашей станции, или
другие файлы, выполняющие те же функции.

4. Файлы конфигурации.

   Все файлы конфигурации - текстовые. Каждая команда или параметр задаются
в одной строке файла конфигурации. Если первым символом (кроме пробелов) в
строке стоит точка с запятой - ";" - эта строка считается строкой комментария
и не обрабатывается. Ниже будут перечислены все файлы конфигурации.

4.1 Основной файл конфигурации (ParToss.Cfg).

   В этом файле описываются параметры станции, режимы работы, особенности
поведения ParToss в различных ситуациях. Все ключевые слова, допустимые
в этом файле, их назначение и формат подробно описаны в комментариях.

4.2 Файл описания архиваторов (Compress.Cfg).

   Этот файл содеpжит описания пpогpамм аpхивации, котоpые Вы хотите
использовать для обмена эхо-почтой. Все ключевые слова, допустимые в этом
файле, их назначение и формат подробно описаны в комментариях.

4.3 Файл описания правил раутинга (Route.Cfg).

   Этот файл управляет паковкой нетмейла на Вашей станции. Если Вы не
разрешили ParToss паковать нетмейл, на этот файл можете не обращать внимания.
Все ключевые слова, допустимые в этом файле, их назначение и формат подробно
описаны в комментариях.

5. Вспомогательные файлы конфигурации.

   Кроме трех основных файлов конфигурации, для выполнения определенных
действий необходимы вспомогательные файлы. Основные из них - файл описаний для
работы функции Post и файл описаний для формирования отчетов об автосоздании
новых эхо-областей. Структура этих файлов одинакова, их формат и назначение
ключевых слов подробно описаны в комментариях.

6. Темплейты.

   Во всех случаях, когда ParToss генерирует письмо - отчет о выполнении
какой-либо функции, автоматически сформированное письмо, автоответ на письмо,
адресованное Вам - в шаблоне, описывающем формат этого письма, могут
использоваться специальные макроподстановки, расширяемые при создании письма.
   Вот полный перечень допустимых макроподстановок:

@TFname  - Первое имя получателя письма
@TLname  - Последнее имя получателя письма (фамилия)
@Tname   - Полное имя получателя письма (поле To:)
@FFname  - Первое имя автора письма
@FLname  - Последнее имя автора письма
@Fname   - Полное имя автора письма (поле From:)
@TAddr   - Адрес получателя письма
@FAddr   - Адрес автора письма
@Area    - Эхо-тэг (наименование) текущей области
@Date    - Текущая дата
@Time    - Текущее время
@Text    - Текст письма, который будет подготовлен автоматически
           (сообщение об автосоздании областей, ответ от эхо-менеджера etc)
@File:   - Имя файла (желательно текстового ;) , который должен быть вставлен
           в письмо и отправлен (например, лог-файл, ежедневно отправляемый
           удаленному сисопу). Если этот файл не существует, поле игнорируется
@Subj    - Тема письма (поле Subj:)
@Version - версия эхопроцессора ParToss (например, "1.04.98 beta for OS/2")
@Return  - перевод строки

7. Запуск программы. Параметры командной строки. Коды ошибок.

   Программа ParToss должна запускаться каждый раз, когда необходимо
произвести импорт пришедшей почты в базу, подготовить к отправке новую почту
или выполнить другие действия, возложенные на ParToss на Вашей станции.

   Формат вызова программы следующий:

ParToss <command> [<command>...] [<key>...] [<node>]

<command> - командное слово, определяющее действия программы:

   In - режим импорта писем из пришедших архивов
   Out - режим экспорта писем в почтовые пакеты
   Send - режим подготовки почтовых пакетов к отправке
   Squash - то же, что и Send
   Pack - то же, что и Send
   Rescan - режим повторной отправки почты для определенного адреса
   Link - режим связывания писем, объединенных общей темой
   Post - режим автоматического создания писем по расписанию
   Serv - режим обработки писем к эхо-менеджеру
   Hand - режим "ручного" запуска эхо-менеджера
   Purge - режим удаления старых писем и упаковки базы
   Kill - режим удаления архивов, не забранных даунлинками в течение
          определенного времени
   Bad - режим разбора писем, ранее классифицированных как "плохие" -
         письма с нарушенной структурой, письма в неизвестную эхо-область
         (при запрещенном автосоздании эхо-областей), письма с нарушением
         режима Secure - и перемещения их в соответствующие области, если
         устранена причина попадания их в область для "плохих" писем
   UnToss - режим разбора эхо-области на отдельные письма с помещением этих
            писем в текстовые файлы с разбивкой по датам
   ReLink - режим "освежения" подписки для синхронизации состояния подписки

   Режимы In, Out, Send, Link, Post, Serv, Purge могут быть заданы
одновременно, в этом случае все действия производятся за один проход
программы, что значительно сокращает время ее работы. Но в этом случае
экспорт и построение цепочек писем будет производиться только для тех эхо-
областей, в которые пришли входящие письма в течение данного запуска. Порядок
выполнения отдельных функций программы при этом зависит от порядка следования
команд в командной строке:
ParToss Post In Out - сначала постинг в эхобазу, затем тоссинг;
ParToss In Out Post - сначала тоссинг, затем постинг.

   В режиме Rescan <node> сканируется вся база, при этом игнорируется тот
факт, что письма были уже отправлены, и формируется пакет для указанного
адреса. Этот режим рекомендуется использовать с большой осторожностью, если
Вы не хотите сделать из Вашей станции мощный дупогенератор. При работе в этом
режиме все остальные команды игнорируются.

   В режиме Serv сканируются нетмейловые области в поисках писем, написанных
на одно из имен эхо-менеджера, проверяется на совпадение адрес получателя и
имя в поле To:. Если такое письмо найдено, проверяются права доступа отправи-
теля письма (наличие его в описании линков и правильность предъявленного
пароля), при удовлетворительном результате проверки выполняются команды,
задаваемые в этом письме, и создаются письма-отчеты о выполненных действиях.

   В режиме Hand выполняется заданная команда для заданного адреса, как при
получении письма к эхо-менеджеру от этого адреса с этой командой. Формат этой
команды задан жестко:
ParToss Hand <address> <command string>
Здесь <address> - адрес одного или нескольких из Ваших постоянных эхо-линков
(может использоваться групповой адрес), <command string> - одна команда к
эхо-менеджеру. Если команда состоит из нескольких слов, разделенных пробелами
(например, %Password SuperPass), она должна быть заключена в кавычки -
"%Password SuperPass"
   Обратите внимание! Большинство команд эхо-менеджера начинаются с символа
'%', который используется в DOS (и других системах) для специальных целей.
Если команда вида
ParToss Hand 2:5030/177.1 %List
приводит к неправильным результатам, используйте символ '#':
ParToss Hand 2:5030/177.1 #List
или другой символ, установленный ключевым словом ManagerGuardCharacter.
   Возможно использование модификации команды Hand - HandNoReport (можно
сократить до пяти символов - Handn). Единственное отличие этой команды
заключается в том, что при ее выполнении подавляется формирование писем-
отчетов. По этой причине нет смысла использовать эту команду с параметрами
%List, %Query, %Notify, %Status, %Links.

   В режиме ReLink для всех или выбранных адресов линков формируются запросы
на подписку на все области, на которые станция подписана у этих линков. Этим
достигается восстановление ошибочно утерянной подписки, например, в случае
технических проблем на узле аплинка.

   В режиме Purge производится физическое удаление старых писем, а также
писем, помеченных как удаленные средствами других программ, и сжатие базы.

   В режиме Kill производится поиск сформированных, но не отправленных
получателю (или не забранных получателем) в течение определенного времени
почтовых архивов. Если такие архивы обнаружены, они удаляются, при этом
формируется отчет о произведенных действиях.

   В режиме Bad производится просмотр области, описанной как BadArea, и
перемещение писем из нее в соответствующие области, если устранены причины,
по которым эти письма попали в BadArea.

   В режиме UnToss производится "разбор" всех или указанных ключом -f эхо-
областей на отдельные письма, причем каждое письмо записывается в отдельный
текстовый файл, и этот файл помещается в подкаталог, соответствующий дате
написания письма. Подкаталоги создаются в каталоге, указанном ключевым словом
UnTossDir. Кроме этого, после имени каталога в этом ключевом слове может быть
задан модификатор Kill, в этом случае все письма после экспорта будут удалены.

   В режиме Post производится обработка специального файла, описывающего
сценарий постинга, в соответствии с указаниями в этом файле генерируются
нетмейловые или эхо-письма и помещаются в указанные области. Пример файла
описания постинга - ParToss.Pst.
   Возможны модификации этого ключевого слова:
   PostF - не производится контроль того факта, что функция постинга сегодня
           уже выполнялась;
   PostD - аналогично PostF, но выполняются только команды постинга с
           периодичностью "ежедневно".

<key> - ключи, модифицирующие поведение программы:

   -8 - принудительное включение режима совместимости по именам файлов эхо-
        областей. При указании этого ключа имена файлов эхо-областей
        приводятся к DOS-стандарту 8.3 отсечением лишних символов имени.
   -c<file> - устанавливает альтернативное имя файла конфигурации, который
              будет использоваться вместо ParToss.Cfg.
   -f<file> - устанавливает имя файла типа EchoToss.Log. В режиме In в этот
              файл будут записываться наименования всех эхо-областей, в
              которые была импортирована свежая почта. В режимах Out и
              Rescan, если задан этот параметр, будут сканироваться только
              те области, которые присутствуют в этом файле, или только та
              область, имя которой задано вместо имени файла. Этот ключ
              используется в многопроходном режиме. По умолчанию сканируются
              все области.
              Если файл с указанным именем не обнаружен, Parma Tosser ищет
              эхо- или нетмейловую область с указанным именем и в случае,
              если такая область обнаружена, обрабатывает ее.
   -k<file> - действует аналогично ключу -f<file>, но указанный файл будет
              удален после обработки.
   -q - режим подавления большей части выводимой на экран информации.
   -s - режим отключения контроля HWM при экспорте. В стандартном режиме
        эхо-области просматриваются в поисках неотправленных писем не с самого
        начала, а с письма, на котором закончилась предыдущая операция Out.
        Позиция, с которой начинается просмотр, запоминается в базе и носит
        название HighWaterMark (HWM). Если необходимо повторно отправить
        ранее написанное и уже отправленное письмо, в командной строке должен
        быть указан этот ключ.
   -t - изменение состояния Secure. Если в файле конфигурации установлен
        режим Secure, этот ключ отменяет его для текущего сеанса работы, и
        наоборот.
   -v - изменение состояния Statistic. Ключ введен для дальнейшего развития.
   -w - режим ожидания в случае, если в момент запуска работает другая копия
        программы. По умолчанию в этом случае происходит завершение работы
        без выполнения запрошенных действий и с выдачей соответствующего
        сообщения. При указании этого ключа вместо немедленного завершения
        работы ParToss будет ожидать завершения работы ранее запущенной копии
        и затем приступит к выполнению запрошенных действий.
   -z - отключение сканирования passthrough областей.

   После завершения работы ParToss возвращает управление вызвавшей его
программе. При этом возвращается код ощибки (ErrorLevel), который может быть
проанализирован вызывающей программой. Предусмотрены следующие коды ошибок:

  0 - нормальное завершение
  9 - неправильный формат вызова программы (выдается экран подсказки)
 10 - не найден один из основных файлов конфигурации
 11 - неизвестное имя эхо-области или не обнаружено описание служебных
      областей (BadArea или DupeArea)
 12 - обнаружено повреждение структуры эхо-области, исключающее возможность
      нормального продолжения работы
 13 - невозможно переименовать временные файлы режима Purge
 14 - запуск второй копии ParToss при отсутствии ключа -w в командной строке
 15 - обнаружено нарушение состояния структур данных в памяти
253 - внутренняя ошибка программы
254 - ошибка модуля свопинга в DOS-версии
255 - ошибка сервиса операционной системы (недостаточно памяти, места на
      диске, ошибка создания или открытия файла, ошибка чтения или записи)

   Этот список не является окончательным, в процессе развития программы могут
быть добавлены новые коды ошибок и изменено значение уже существующих.

8. Основные функции.

8.1 Функция импорта почты.

   Вызывается командой ParToss In. По этой команде производится просмотр всех
входных каталогов (каталоги, заданные в файле конфигурации ключевыми словами
NetFile, Inbound, SecureInbound и WorkDir) в поисках почтовых пакетов и
архивов. При обнаружении архивированной почты (ArcMail) производится попытка
извлечь ее из архивов. После этого все обнаруженные пакеты просматриваются и
имеющиеся в них письма импортируются в базу эхо-конференций. При необходимости
также производится создание новых областей и копирование писем, написанных
конкретным человеком или адресованных конкретному человеку (или имеющих другие
признаки, описанные в ключевых словах карбонкопирования), в отведенные для
этого области. После окончания работы входные архивы и пакеты либо удаляются,
либо (в случае обнаружения каких-либо ошибок) переименовываются.

8.2 Функция экспорта почты.

   Вызывается командой ParToss Out. По этой команде производится просмотр
почтовой базы в поисках новых или неотправленных писем и упаковка их в пакеты
для отправки подписчикам.

8.3 Функция подготовки пакетов к отправке.

   Вызывается командой ParToss Send (возможные синонимы команды - Squash или
Pack). По этой команде производится поиск в выходном каталоге подготовленных
пакетов, архивация их и подготовка к отправке с помощью Вашего мейлера. При
этом поддерживаются следующие режимы работы мейлера:
 - ArcmailAttach - для каждого сформированного архива создается письмо со
специальным атрибутом Att, которое указывает мейлеру, что определенный файл
должен быть отправлен по определенному адресу;
 - FileBoxes - сформированные архивы перемещаются в подкаталоги, имеющие
специальные имена, понятные мейлеру T-Mail, или имена, заданные для каждого
подписчика;
 - BinkMode - сформированные архивы перемещаются в подкаталоги, имеющие
специальные имена, и имена файлов архивов вносятся в специальные файлы,
по наличию и содержанию которых мейлер определяет необходимость отправить
эти файлы на определенные адреса.

   Режимы ArcmailAttach, FileBoxes и BinkMode могут использоваться совместно,
при этом почта на одни адреса отправляется с использованием Attach-писем, а на
другие адреса - с использованием файл-боксов и/или Bink Outbound.

   При желании можно заставить ParToss выполнять команду Send автоматически
при выполнении команды Out с помощью ключевого слова AutoSend в файле
конфигурации.

8.4 Однопроходный режим.

   Команды In, Out и Send могут быть заданы одновременно. В этом случае при
разборе входных пакетов на письма одновременно производится упаковка писем в
выходные пакеты и импорт их в базу, а также сканирование тех эхо-областей, в
которые пришла почта, с целью обнаружения в них неотправленных писем, и их
отправка. Этот режим значительно быстрее и удобнее режима отдельных проходов
для каждого режима, если Ваша станция пересылает большой объем транзитной
почты.

8.5 Повторная отправка почты.

   Вызывается командой ParToss ReScan <address>. По этой команде
просматривается база и отправляется почта на указанный адрес, при этом
игнорируется тот факт, что письма уже были отправлены на этот адрес. Для
обработки только определенной области или группы областей используйте флаг
-fEchoToss.Log (-fAREATAG).

9. Вспомогательные функции.

9.1 Функция построения цепочек "вопрос-ответ" (линковки базы).

   Вызывается командой ParToss Link. По этой команде база эхо-конференций
анализируется на предмет наличия в отдельных областях писем, объединенных
одной темой, и строятся цепочки "вопрос-ответ". Принадлежность письма к той
или иной цепочке определяется либо по содержанию поля Subj (тема письма),
либо по специальным строкам - @MSGID (идентификатор письма) и @REPLY (ссылка
на исходное письмо). Во втором случае цепочка связанных писем может иметь
нелинейную структуру, когда на одно письмо пришло более одного ответа. Вы
можете выбрать наиболее устраивающий Вас метод линковки в соответствии с
Вашими привычками и возможностями Вашего почтового редактора.

   Если выбран метод линковки по Subj, Вы можете указать, что принадлежность
писем к одной цепочке должна определяться не всем полем Subj писем, а его
частью, и задать длину этой части. Ведущие символы "Re:" и пробелы удаляются
перед анализом поля Subj.

   Метод линковки по @MSGID/@REPLY имеет три варианта - построение древовидной
структуры цепочек, разворачивание древовидной структуры в линейную цепочку, а
также метод "длинных" цепочек, при котором, кроме цепочек "вопрос-ответ" также
строятся цепочки вида "ответ-ответ", то есть ответы на одно и то же письмо
объединяются в одну цепочку.

   Вы можете задать свой метод линковки для каждой эхо-области в описании
этой эхо-области. Помимо перечисленных выше методов, Вы можете выбрать метод
None, отключающий линковку данной области.

   Вы можете также включить режим линковки нетмейла, но в этом случае будет
производиться линковка по полю Subj - другие методы линковки нетмейловых
областей не поддерживаются.

   Существует модификация команды Link - LinkF. Этот режим работает быстрее,
но требует для работы больше памяти, поэтому он рекомендуется к использованию
только в многозадачных системах.

9.2 Функция автоматической рассылки писем.

   Вызывается командой ParToss Post. По этой команде анализируется текстовый
файл определенного формата, содержащий описания писем, которые необходимо
отправить в определенные дни, и при необходимости создаются письма, которые
после этого могут быть отправлены по нужным адресам.
   Модификация команды - ParToss PostF. При этом не проверяется дата
последней корректировки файла описаний, что позволяет выполнять эту команду
сразу после его редактирования, а также выполнять ее несколько раз в течение
дня.
   Еще одна модификация - PostD. Она аналогична предыдущей, но при этом
обрабатываются только события, описанные как ежедневные.

9.3 Функция удаленного управления подпиской (эхо-менеджер).

   Вызывается командой ParToss Serv. По этой команде просматриваются все
письма в каталогах с нетмейлом в поисках писем, адресованных на Ваш адрес и
на одно из имен менеджера, описанных в файле конфигурации. При обнаружении
таких писем анализируется адрес отправителя письма, его пароль и затем
просматривается текст письма в поисках команд к эхо-менеджеру. Все эти команды
выполняются, при этом готовятся письма, содержащие отчет о выполненной работе.

9.4 Функция локального управления подпиской ("ручной" эхо-менеджер).

   Вызывается командой ParToss Hand. По этой команде имитируется письмо от
одного из подписчиков (или от нескольких подписчиков), адресованное на Ваш
адрес и на одно из имен, описанных в файле конфигурации. Затем для этого
"письма" (или "писем") выполняется заданная команда, при этом готовятся
письма, содержащие отчет о выполненной работе.
   Модификация команды - ParToss HandN. При этом подавляется формирование
отчетов о выполненной работе.

9.5 Функция отправки архивированного нетмейла.

   Обычно нетмейл пересылается между станциями в неархивированном виде. Но
в отдельных случаях (большой объем почты, плохое качество связи etc.) более
удобно пересылать нетмейл в том же виде, что и эхо-почту. Вы можете указать,
нетмейл на какие адреса или группы адресов Вы хотите отправлять в
архивированном виде, и ParToss будет анализировать каталог с нетмейлом так же,
как и базу эхо-конференций. Но обработке в этом режиме подлежат только письма,
не имеющие специальных атрибутов (Dir, Cra, Frq, Urq, Att).

9.6 Функция ограничения размеров почтовых архивов.

   В случае, если через Вашу станцию проходит большой объем почты, размеры
выходных пакетов могут оказаться слишком большими для их безболезненной
пересылки подписчикам. Для решения этой проблемы предназначена встроенная
эхо-пила, которая после достижения определенного размера выходного пакета
начнет упаковывать почту в другой пакет. В результате вместо одного большого
архива получится несколько маленьких. Размеры пакетов можно устанавливать
отдельно для каждого подписчика. При этом можно ограничивать размеры как самих
пакетов, так и архивов, в которые будут упаковываться эти пакеты.

9.7 Функция упаковки базы.

   В процессе работы программы в файлах базы могут возникать "дыры" - места,
не занятые письмами, удаленные письма. Для сжатия файлов базы после удаления
писем, а также для удаления писем с истекшим сроком хранения, необходимо
регулярно выполнять упаковку базы, которая вызывается командой ParToss Purge.

9.8 Функция удаления старых архивов.

   Эта функция предназначена для того, чтобы в случае, если Ваш подписчик не
забирает предназначенную для него почту в течение длительного времени, его
архивы были автоматически удалены. Количество дней хранения почты
устанавливается отдельно для каждого подписчика. Эта функция вызывается
командой ParToss Kill.

9.9 Функция автоматического разбора забракованных писем.

   В процессе работы возможны ситуации, когда часть пришедших на станцию
писем будет помещена в BadArea. Это случается при поступлении писем в эхо-
область, которая отсутствует на станции (при запрещенном режиме автосоздания
эхо-областей), при поступлении писем в некоторую эхо-область со станции,
которая не подписана на эту конференцию на Вашей станции или подписана на нее
в режиме Read-Only, а также при обнаружении писем с нарушенной структурой при
невозможности автоматического восстановления структуры. В некоторых случаях
это происходит из-за ошибки системного оператора станции, и появляется
необходимость переместить письма в соответствующую конференцию. Для этого
предназначена функция разбора BadArea. Она сканирует область, описанную как
BadArea, и перемещает письма из нее в соответствующие области. После
выполнения этой функции письма, успешно перемещенные в соответствующие
области, удаляются из BadArea. Эта функция вызывается командой ParToss Bad.

9.10 Функция разбора эхо-области на текстовые файлы.

   Эта функция предназначена для экзотических целей - например, для подготовки
писем эхо-области к помещению в информационно-поисковую систему. При
выполнении этой функции в указанном каталоге создаются каталоги,
соответствующие датам создания писем (например, 20 апреля 1997 года -
19970420), а затем в этих каталогах создаются текстовые копии писем
эхо-области, в первых строках которых сохраняется информация об отправителе,
адресате и теме письма. После выполнения команды эхо-область может быть
очищена от обработанных писем. Если необходимо обработать не все эхо-области,
а одну или несколько, используйте ключ -fEchotoss.log. Эта функция вызывается
командой ParToss UnToss.

9.11 Функция восстановления подписки.

   Время от времени по разным причинам может произойти рассинхронизация
подписки - например, на какую-то область на нашей станции подписан какой-то
узел, а наша станция не подписана у этого узла на эту область. Такая ситуация
может произойти, например, при потере файлов конфигурации на удаленном узле
в результате дискового сбоя. Для возобновления подписки служит команда ReLink.
При выполнении этой функции производится формирование письма с запросом на
подписку для всех областей, на которые станция подписана у указанного узла,
и отправка ему этого запроса.

10. Внешние программы.

   Для разархивации пришедших почтовых архивов и архивации выходных пакетов
используются внешние программы - архиваторы. Для того, чтобы ParToss смог
правильно определить, какой архиватор вызывать и с какими параметрами, служит
файл описания архиваторов. При необходимости можно указать, что запуск
архиваторов должен производиться со свопингом (если без этого недостаточно
памяти, только в версии для DOS). При выполнении свопинга используется функция
SwapExec Михаила Лихачева. Свопинг может производиться на диск, в EMS или в
XMS.

11. Благодарности.

   Прежде всего хочется поблагодарить создателей FidoNET, а также автора
прекрасной программы Squish за то, что при работе с ней все время хотелось
ее улучшить.
   Спасибо всем, кто помогал и помогает мне в работе над программой:
   Петр Сучков (2:5030/51) - автор идеи написания этой программы и
неутомимый погоняльщик. Если бы не его настойчивость, ParToss не был бы создан
никогда.
   Михаил Лихачев (2:5030/131), предоставивший функцию свопинга SwapExec и
много раз модифицировавший ее в соответствии с моими пожеланиями.
   Вадим Белман (2:464/15) - автор модуля быстрой линковки LinkF.
   Андрей Елкин (2:5030/15) - автор идеи файл-боксов, оказывавший помощь в
реализации этого режима и консультировавший меня по ряду вопросов FTN-
технологии.
   Анатолий Скоблов (2:5030/78) - благодаря его советам и разъяснениям
ParToss научился быстрее работать с большим количеством выходных пакетов.
   Андрей Косяков (2:5030/31), Борис Адливанкин (2:5030/185) - никогда не
отказывались помочь мне в преодолении сложных для меня проблем.
   Слава Ольховченков (2:5030/51.4) - главный консультант и критик. Из его
T-API украден алгоритм работы с Bink-style outbound. Он также откорректировал
для более надежной работы описания некоторых архиваторов.
   Юрий Фрадкин (2:5030/339) - главный бета-тестер. Количество обнаруженных
им ошибок многократно превышает количество строк исходного текста программы.
   Илья Богданов (2:5030/184),
   Максим Дунин (2:5020/28.53),
   Сергей Романовский (2:5020/236.12),
   Денис Савельев (2:5030/37)
   и еще десятки пользователей бета-версий Parma Tosser -
   настолько злобные бета-тестеры, что работа над ошибками заметно ускорилась.
   Дискуссии в эхо-областях SU.FIDOTECH, RU.ECHOPROCESSORS, SU.MAILER,
   GSS.GENERAL, GSS.PARTOSS помогли мне преодолеть некоторые мои заблуждения.

12. Статус программы.

   Программа Parma Tosser имеет статус ShareWare. О том, как зарегистрировать
эту программу, можно узнать, прочитав файл Register.Doc.

13. Обратный адрес.

Serge Koghin
2:5030/177@fidonet
2:5030/777@fidonet
serge@kibr.spb.ru
http://parma.kibr.spb.ru

   Все использованные в данной документации названия программ, сетей, форматов
данных и прочего, возможно, являются зарегистрированными торговыми марками.
А возможно, и нет.
